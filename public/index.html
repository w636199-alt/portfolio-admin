<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Portfolio Admin</title>

<script src="https://cdn.tailwindcss.com"></script>
<link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
<script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
  import { getFirestore, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";
  import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBsrXwcDBvaSOZct9DiYpZHzoIdFyV4NJc",
    authDomain: "wpsh-portfolio.firebaseapp.com",
    projectId: "wpsh-portfolio",
    storageBucket: "wpsh-portfolio.appspot.com",
    messagingSenderId: "654096898034",
    appId: "1:654096898034:web:277a6d479cac10897c3d6b",
    measurementId: "G-3CJ68T2L16"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const auth = getAuth(app);
  window.fb = { db, auth, doc, setDoc, getDoc, onAuthStateChanged, signInWithEmailAndPassword, signOut };
</script>

<style>
  .quill-editor .ql-editor { min-height: 110px; max-height: 260px; overflow-y: auto; }
  .modal { display: none; position: fixed; z-index: 50; inset: 0; background: rgba(0,0,0,0.7); justify-content: center; align-items: center; }
  .modal img { max-width: 90%; max-height: 90%; border-radius: 12px; box-shadow: 0 10px 25px rgba(0,0,0,0.5); }
  .project-preview { min-width: 10rem; min-height: 10rem; cursor: pointer; }
  .drag-handle { cursor: grab; }
  .drag-handle:active { cursor: grabbing; }
  #saveBtn:disabled { background-color: #f472b6; cursor: not-allowed; }
</style>
</head>

<body class="bg-gray-50 font-sans">

<div id="loginContainer" class="min-h-screen flex items-center justify-center">
  <div class="bg-white p-8 rounded-2xl shadow-md w-full max-w-sm">
    <h2 class="text-2xl font-bold text-pink-600 mb-6 text-center">Admin Login</h2>
    <form id="loginForm" class="space-y-4">
      <input type="email" id="loginEmail" placeholder="Email" required class="w-full border rounded-lg p-3 focus:outline-none focus:ring-2 focus:ring-pink-500">
      <input type="password" id="loginPassword" placeholder="Password" required class="w-full border rounded-lg p-3 focus:outline-none focus:ring-2 focus:ring-pink-500">
      <button type="submit" class="w-full bg-pink-600 text-white p-3 rounded-lg shadow hover:bg-pink-700 transition">Login</button>
      <p id="loginError" class="text-red-500 text-sm text-center h-4"></p>
    </form>
  </div>
</div>

<main id="adminContent" class="hidden">
  <div class="flex justify-between items-center max-w-4xl mx-auto px-6 pt-6">
    <h1 class="text-2xl font-bold text-gray-800">Portfolio Admin</h1>
    <button id="logoutBtn" class="bg-gray-200 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-300 transition">Logout</button>
  </div>
  
  <div class="max-w-4xl mx-auto p-6 space-y-10">
    <!-- Resume -->
    <section class="bg-white p-6 rounded-2xl shadow-md">
      <h2 class="text-xl font-bold text-pink-600 mb-4">Resume</h2>
      <input type="file" id="resumeUpload" accept=".pdf,.doc,.docx" class="mb-3 block w-full text-sm text-gray-700 file:mr-4 file:py-2 file:px-3 file:rounded-lg file:border-0 file:bg-pink-100 file:text-pink-700 hover:file:bg-pink-200 focus:outline-none focus:ring-2 focus:ring-pink-500">
      <div id="resumePreview" class="text-gray-700 font-medium"></div>
      <button id="removeResumeBtn" class="mt-3 hidden border border-pink-400 text-pink-700 px-3 py-1.5 rounded-lg hover:bg-pink-50 focus:outline-none focus:ring-2 focus:ring-pink-500 transition">ðŸ—‘ Remove Resume</button>
    </section>
    
    <!-- About Me -->
    <section class="bg-white p-6 rounded-2xl shadow-md">
      <h2 class="text-xl font-bold text-pink-600 mb-4">About Me</h2>
      <textarea id="aboutInput" rows="4" class="w-full border rounded-lg p-3 focus:outline-none focus:ring-2 focus:ring-pink-500" placeholder="Write about yourself..."></textarea>
    </section>

    <!-- Projects -->
    <section class="bg-white p-6 rounded-2xl shadow-md">
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-xl font-bold text-pink-600">Projects</h2>
        <button id="addProjectBtn" class="bg-pink-500 text-white px-3 py-2 rounded-lg shadow hover:bg-pink-600 transition">+ Add Project</button>
      </div>
      <p class="text-sm text-gray-500 mb-3">Tip: drag with the <span class="text-pink-600 font-semibold">handle</span> (â‰¡) to reorder.</p>
      <div id="projectsContainer" class="space-y-6"></div>
    </section>

    <!-- Contact -->
    <section class="bg-white p-6 rounded-2xl shadow-md">
      <h2 class="text-xl font-bold text-pink-600 mb-4">Contact Info</h2>
      <input type="text" id="emailInput" class="w-full border rounded-lg p-3 mb-3 focus:outline-none focus:ring-2 focus:ring-pink-500" placeholder="Email">
      <input type="text" id="linkedinInput" class="w-full border rounded-lg p-3 mb-3 focus:outline-none focus:ring-2 focus:ring-pink-500" placeholder="LinkedIn URL">
      <input type="text" id="githubInput" class="w-full border rounded-lg p-3 focus:outline-none focus:ring-2 focus:ring-pink-500" placeholder="GitHub URL">
    </section>
    
    <button id="saveBtn" class="fixed bottom-5 right-5 bg-pink-600 text-white px-4 py-2 rounded-lg shadow-lg hover:bg-pink-700 transition">ðŸ’¾ Save Portfolio</button>
  </div>
</main>

<div id="imageModal" class="modal" aria-label="Image modal">
  <img id="modalImage" src="" alt="Zoomed project image">
</div>

<div id="saveToast" class="hidden fixed bottom-20 right-5 z-50 bg-pink-600 text-white px-4 py-2 rounded-lg shadow-lg"></div>

<script type="module"> 
const { db, auth, doc, setDoc, getDoc, onAuthStateChanged, signInWithEmailAndPassword, signOut } = window.fb;

const quillInstances = {};
const DEFAULT_IMG_SRC = 'data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7';

const elements = {
  loginContainer: document.getElementById("loginContainer"),
  loginForm: document.getElementById("loginForm"),
  loginEmail: document.getElementById("loginEmail"),
  loginPassword: document.getElementById("loginPassword"),
  loginError: document.getElementById("loginError"),
  adminContent: document.getElementById("adminContent"),
  logoutBtn: document.getElementById("logoutBtn"),
  resumeUpload: document.getElementById("resumeUpload"),
  resumePreview: document.getElementById("resumePreview"),
  removeResumeBtn: document.getElementById("removeResumeBtn"),
  aboutInput: document.getElementById("aboutInput"),
  projectsContainer: document.getElementById("projectsContainer"),
  addProjectBtn: document.getElementById("addProjectBtn"),
  emailInput: document.getElementById("emailInput"),
  linkedinInput: document.getElementById("linkedinInput"),
  githubInput: document.getElementById("githubInput"),
  saveBtn: document.getElementById("saveBtn"),
  imageModal: document.getElementById("imageModal"),
  modalImage: document.getElementById("modalImage"),
  saveToast: document.getElementById("saveToast"),
};

function showToast(message) {
  elements.saveToast.textContent = message;
  elements.saveToast.classList.remove("hidden");
  setTimeout(() => elements.saveToast.classList.add("hidden"), 2000);
}

function openModal(src) {
  if (!src || src === DEFAULT_IMG_SRC) return;
  elements.modalImage.src = src;
  elements.imageModal.style.display = "flex";
}

function addProject(data = {}) {
  const projectId = `project-${Date.now()}`;
  const div = document.createElement("div");
  div.className = "project-item bg-gray-50 p-4 rounded-xl shadow border border-gray-200";
  div.setAttribute('data-project-id', projectId);

  div.innerHTML = `
    <div class="flex items-center gap-3 mb-3">
      <button class="drag-handle shrink-0 text-pink-600 hover:text-pink-700" title="Drag to reorder">&#x2261;</button>
      <input type="text" class="flex-1 border rounded-lg px-3 py-2 project-title focus:outline-none focus:ring-2 focus:ring-pink-500" placeholder="Project Title" value="${data.title||''}">
      <input type="text" class="w-64 border rounded-lg px-3 py-2 project-role focus:outline-none focus:ring-2 focus:ring-pink-500" placeholder="Role / Technologies" value="${data.role||''}">
    </div>
    <div class="quill-editor mb-3" id="editor-${projectId}"></div>
    <label class="block text-sm font-medium text-gray-700 mb-2">Project Image</label>
    <div class="flex items-center gap-4">
      <input type="file" accept="image/*" class="project-image block w-full text-sm text-gray-700 file:mr-4 file:py-2 file:px-3 file:rounded-lg file:border-0 file:bg-pink-100 file:text-pink-700 hover:file:bg-pink-200 focus:outline-none focus:ring-2 focus:ring-pink-500">
      <img src="${data.localUrl||DEFAULT_IMG_SRC}" class="project-preview w-28 h-28 rounded-lg object-cover border" title="Click to zoom" data-git-url="${data.gitUrl||''}" data-filename="${data.filename||'image_'+projectId}">
      <button class="removeProjectPhotoBtn text-red-600 px-2 py-1 rounded-lg border border-red-400 hover:bg-red-100">ðŸ—‘ Remove Photo</button>
    </div>
    <button class="removeProjectBtn mt-3 bg-red-100 text-red-600 px-3 py-1 rounded-lg hover:bg-red-200 transition">Remove</button>
  `;
  elements.projectsContainer.appendChild(div);

  const quill = new Quill(`#editor-${projectId}`, { theme: 'snow', placeholder: 'Project description...' });
  if (data.desc) quill.root.innerHTML = data.desc;
  quillInstances[projectId] = quill;
}

function updateResumeUI(resumeData) {
  if(!resumeData) return clearResumeUI();
  elements.resumePreview.innerHTML = `<a href="${resumeData.localUrl}" target="_blank" class="text-pink-600 underline" data-git-url="${resumeData.gitUrl||''}" data-filename="${resumeData.filename||'resume.pdf'}">View Resume</a>`;
  elements.removeResumeBtn.classList.remove("hidden");
}

async function deleteFile(filePath, endpoint) {
  if (!filePath) return;
  try {
    await fetch(endpoint, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ filePath })
    });
  } catch (err) {
    console.error(`Failed to delete file at ${filePath}:`, err);
  }
}

async function clearResumeUI() {
  const resumeLink = elements.resumePreview.querySelector("a");
  if (resumeLink) {
    // Store local URL before clearing
    const filePath = resumeLink.getAttribute("href"); // e.g., /uploads/resume/resume.pdf
    try {
      // Delete resume from server
      const response = await fetch("/delete-resume", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ filePath })
      });
      if (!response.ok) throw new Error(`Server responded ${response.status}`);
      showToast("ðŸ—‘ Resume removed");
    } catch (err) {
      console.error("Failed to delete resume on server:", err);
      showToast("âŒ Failed to remove resume");
    }
  }

  // Clear UI
  elements.resumePreview.innerHTML = "";
  elements.resumeUpload.value = "";
  elements.removeResumeBtn.classList.add("hidden");
}

// Event listener
elements.removeResumeBtn.addEventListener("click", clearResumeUI);

async function uploadFile(endpoint, formData) {
  try {
    const response = await fetch(endpoint, { method: "POST", body: formData });
    if (!response.ok) throw new Error(`Upload failed with status: ${response.status}`);
    return await response.json();
  } catch (error) {
    console.error(`Error uploading file to ${endpoint}:`, error);
    alert("File upload failed. Check server at localhost:3000");
    return null;
  }
}

async function savePortfolio() {
  elements.saveBtn.disabled = true;
  elements.saveBtn.textContent = 'ðŸ’¾ Saving...';
  try {
    const resumeLink = elements.resumePreview.querySelector("a");
    const resumeData = resumeLink ? {
      localUrl: resumeLink.href||"",
      gitUrl: resumeLink.dataset.gitUrl||"",
      filename: resumeLink.dataset.filename||"resume.pdf"
    } : null;

    const projects = [];
    document.querySelectorAll(".project-item").forEach(div => {
      const id = div.dataset.projectId;
      const previewImg = div.querySelector(".project-preview");
      projects.push({
        title: div.querySelector(".project-title").value || "",
        role: div.querySelector(".project-role").value || "",
        desc: quillInstances[id]?.root.innerHTML || "",
        localUrl: previewImg?.src || "",
        gitUrl: previewImg?.dataset.gitUrl || "",
        filename: previewImg?.dataset.filename || "",
        projectId: id
      });
    });

    const portfolioData = {
      about: elements.aboutInput.value||"",
      email: elements.emailInput.value||"",
      linkedin: elements.linkedinInput.value||"",
      github: elements.githubInput.value||"",
      resume: resumeData,
      projects: projects
    };

    await setDoc(doc(db, "portfolio", "main"), portfolioData);
    showToast("âœ… Saved!");
  } catch (error) {
    console.error("Error saving portfolio:", error);
    showToast("âŒ Error saving!");
  } finally {
    elements.saveBtn.disabled = false;
    elements.saveBtn.textContent = 'ðŸ’¾ Save Portfolio';
  }
}

async function loadPortfolio() {
  try {
    const snap = await getDoc(doc(db, "portfolio", "main"));
    if (!snap.exists()) return;
    const data = snap.data();

    elements.aboutInput.value = data.about || "";
    elements.emailInput.value = data.email || "";
    elements.linkedinInput.value = data.linkedin || "";
    elements.githubInput.value = data.github || "";
    updateResumeUI(data.resume||null);

    elements.projectsContainer.innerHTML = '';
    Object.keys(quillInstances).forEach(key => delete quillInstances[key]);
    if (data.projects && Array.isArray(data.projects)) data.projects.forEach(proj => addProject(proj));
  } catch (error) {
    console.error("Error loading portfolio:", error);
  }
}

function setupEventListeners() {
  elements.addProjectBtn.addEventListener("click", () => addProject());
  elements.saveBtn.addEventListener("click", savePortfolio);
  elements.removeResumeBtn.addEventListener("click", clearResumeUI);
  elements.imageModal.addEventListener("click", (e) => { 
    if (e.target.id === "imageModal") e.currentTarget.style.display = "none"; 
  });

  elements.resumeUpload.addEventListener("change", async (e) => {
    const file = e.target.files[0];
    if (!file) return;
    const formData = new FormData();
    formData.append("resumeFile", file);
    const data = await uploadFile("/upload-resume", formData);
    if (data && data.localUrl) updateResumeUI(data);
  });

  elements.projectsContainer.addEventListener("change", async (e) => {
    const target = e.target;
    if (target.classList.contains("project-image")) {
      const file = target.files[0];
      if (!file) return;
      const projectItem = target.closest('.project-item');
      const previewImg = projectItem?.querySelector('.project-preview');
      if (!previewImg) return;
      const formData = new FormData();
      formData.append("projectImage", file);
      formData.append("projectId", projectItem.dataset.projectId);
      const data = await uploadFile("/upload-project-image", formData);
      if (data && data.localUrl) {
        previewImg.src = data.localUrl;
        previewImg.dataset.gitUrl = data.gitUrl||"";
        previewImg.dataset.filename = data.filename||previewImg.dataset.filename;
      }
    }
  });

  elements.projectsContainer.addEventListener("click", async (e) => {
  const target = e.target;
  const projectItem = target.closest(".project-item");
  if (!projectItem) return;

  // Remove entire project block
  if (target.classList.contains("removeProjectBtn")) {
    const previewImg = projectItem.querySelector(".project-preview");

    // Delete the image first if exists
    if (previewImg && previewImg.src !== DEFAULT_IMG_SRC) {
      let filename = previewImg.dataset.filename;
      if (!filename) {
        const urlParts = previewImg.src.split("/");
        filename = urlParts[urlParts.length - 1];
      }
      try {
        const res = await fetch("/delete-project-image", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ filename })
        });
        if (!res.ok) throw new Error(`Server responded ${res.status}`);
        showToast("ðŸ—‘ Project removed with image");
      } catch (err) {
        console.error("Failed to delete project image:", err);
        showToast("âŒ Failed to remove image");
      }
    }

    // Remove project block from DOM
    projectItem.remove();

  // Open modal for image preview
  } else if (target.classList.contains("project-preview")) {
    openModal(target.src);

  // Remove only project photo
  } else if (target.classList.contains("removeProjectPhotoBtn")) {
    const previewImg = projectItem.querySelector(".project-preview");
    if (!previewImg || previewImg.src === DEFAULT_IMG_SRC) return;

    let filename = previewImg.dataset.filename;
    if (!filename) {
      const urlParts = previewImg.src.split("/");
      filename = urlParts[urlParts.length - 1];
    }

    try {
      const res = await fetch("/delete-project-image", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ filename })
      });
      if (!res.ok) throw new Error(`Server responded ${res.status}`);
      previewImg.src = DEFAULT_IMG_SRC;
      previewImg.dataset.gitUrl = "";
      previewImg.dataset.filename = `image_${projectItem.dataset.projectId}`;
      showToast("ðŸ—‘ Project image removed");
    } catch (err) {
      console.error("Failed to delete project image:", err);
      showToast("âŒ Failed to remove image");
    }
  }
});
}

// --- Authentication ---
elements.loginForm.addEventListener('submit', async (e) => {
  e.preventDefault();
  elements.loginError.textContent = '';
  const email = elements.loginEmail.value;
  const password = elements.loginPassword.value;
  try { await signInWithEmailAndPassword(auth, email, password); }
  catch { elements.loginError.textContent = "Login failed. Check email or password."; }
});

elements.logoutBtn.addEventListener('click', async () => {
  try { await signOut(auth); }
  catch (error) { console.error("Sign out failed:", error); }
});

// Auto Logout Timer
let logoutTimer;
const LOGOUT_TIME = 5 * 60 * 1000;
function resetLogoutTimer() {
  if (logoutTimer) clearTimeout(logoutTimer);
  logoutTimer = setTimeout(async () => {
    alert("Session expired. Logging out...");
    try { await signOut(auth); } 
    catch (err) { console.error("Auto logout failed:", err); }
  }, LOGOUT_TIME);
}
['mousemove', 'keydown', 'click'].forEach(event => document.addEventListener(event, resetLogoutTimer));

onAuthStateChanged(auth, (user) => {
  if (user) {
    elements.loginContainer.classList.add('hidden');
    elements.adminContent.classList.remove('hidden');
    setupEventListeners();
    loadPortfolio();
    new Sortable(elements.projectsContainer, { handle: ".drag-handle", animation: 150 });
    resetLogoutTimer();
  } else {
    elements.loginContainer.classList.remove('hidden');
    elements.adminContent.classList.add('hidden');
  }
});
</script>

</body>
</html>
